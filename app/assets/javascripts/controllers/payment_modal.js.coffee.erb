App.controller 'PaymentModal', ['$scope', 'Subscription', ($scope, Subscription) ->
  Stripe.setPublishableKey('<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>')

  repo = $scope.repo

  monthlyCost = ->
    if repo.private
      if repo.in_organization
        24
      else
        9
    else
      0

  stripeResponseHandler = (status, response) ->
    subscription = new Subscription(
      repo_id: repo.id,
      card_token: response.id
    )
    subscription.$save()

  $scope.monthlyCost = monthlyCost()

  $scope.processPayment = ->
    Stripe.card.createToken(
      {
        number: $scope.paymentNumber,
        exp_month: $scope.paymentExpiryMonth,
        exp_year: $scope.paymentExpiryYear,
        cvc: $scope.paymentCVC
      },
      stripeResponseHandler
    )
]
